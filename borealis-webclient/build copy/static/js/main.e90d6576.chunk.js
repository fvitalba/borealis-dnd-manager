(this["webpackJsonpborealis-webclient"]=this["webpackJsonpborealis-webclient"]||[]).push([[0],{17:function(e,t,n){},18:function(e,t,n){},30:function(e,t,n){"use strict";n.r(t);var a=n(2),o=n.n(a),r=n(6),i=n.n(r),s=(n(17),n(18),n(9)),c=n(3),u=n(1),l="SETTINGS/CHANGE_CURSORSIZE",d="SETTINGS/CHANGE_FOG_SETTINGS",g="SETTINGS/CHANGE_DRAW_SETTINGS",p="SETTINGS/CHANGE_TOOL",j="SETTINGS/CHANGE_USERNAME",m="SETTINGS/TOGGLE_MOUSESHARING",b="GAME/OVERWRITE_GAME",f="GAME/LOAD_MAP",h="GAME/INCREMENT_GEN",O="GAME/SET_ISFOGLOADED",v="GAME/SET_ISFIRSTLOADDONE",w="GAME/UPDATE_MAPS",x="GAME/ADD_MAP",S="GAME/DELETE_APP",k="GAME/UPDATE_TOKENS",y="GAME/ADD_TOKEN",C="GAME/DELETE_TOKEN",T="GAME/COPY_TOKEN",E="GAME/UPDATE_TOKEN_VALUE",I="GAME/TOGGLE_TOKEN_VALUE",N="GAME/RESET_FOG",P="GAME/RESET_DRAW",M="METADATA/SET_GAMESETTINGS",R="METADATA/SET_CURSORS",A="METADATA/SET_LAST_COORDINATES",D="METADATA/SET_DOWN_COORDINATES",G=function(){return{cursorSize:50,fogOpacity:.5,fogRadius:75,drawColor:"white",drawSize:8,tool:"move",subtool:void 0,username:new URLSearchParams(window.location.href.replace(/.*\?/,"")).get("host")?"DM":"PC",shareMouse:!0}},z=function(e){return{type:l,cursorSize:parseInt(e)}},U=function(e,t){return{type:p,tool:e,subtool:t}},L=function(e){return{type:j,username:e}},_=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:G(),t=arguments.length>1?arguments[1]:void 0;switch(t.type){case l:return Object(u.a)(Object(u.a)({},e),{},{cursorSize:t.cursorSize});case d:return Object(u.a)(Object(u.a)({},e),{},{fogOpacity:t.fogOpacity,fogRadius:t.fogRadius});case g:return Object(u.a)(Object(u.a)({},e),{},{drawColor:t.drawColor,drawSize:t.drawSize});case p:return Object(u.a)(Object(u.a)({},e),{},{tool:t.tool,subtool:t.subtool});case j:return Object(u.a)(Object(u.a)({},e),{},{username:t.username});case m:return Object(u.a)(Object(u.a)({},e),{},{shareMouse:!e.shareMouse});default:return e}},$={isHost:void 0,room:void 0,cursors:[],lastX:void 0,lastY:void 0,downX:void 0,downY:void 0},F=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case M:return Object(u.a)(Object(u.a)({},e),{},{isHost:t.isHost,room:t.room});case R:return Object(u.a)(Object(u.a)({},e),{},{cursors:t.cursors});case A:return Object(u.a)(Object(u.a)({},e),{},{lastX:t.lastX,lastY:t.lastY});case D:return Object(u.a)(Object(u.a)({},e),{},{downX:t.downX,downY:t.downY});default:return e}},H=n(5),W=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=window.crypto.getRandomValues(new Uint32Array(1))[0]*Math.pow(2,-32)*16|0;return("x"===e?t:3&t|8).toString(16)}))},J={mapId:void 0,gen:0,width:window.innerWidth,height:window.innerHeight,isFogLoaded:!1,isFirstLoadDone:!1,maps:[],tokens:[]},V=function(e){return{type:f,mapId:parseInt(e)}},K=function(e){return{type:w,maps:e}},Y=function(e){return{type:k,tokens:e}},X=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:J,t=arguments.length>1?arguments[1]:void 0,n=JSON.parse(JSON.stringify(e.maps)),a=JSON.parse(JSON.stringify(e.tokens));switch(t.type){case b:return Object(u.a)(Object(u.a)({},e),t.game);case f:return Object(u.a)(Object(u.a)({},e),{},{mapId:parseInt(t.mapId)});case h:return Object(u.a)(Object(u.a)({},e),{},{gen:e.gen+1});case O:return Object(u.a)(Object(u.a)({},e),{},{isFogLoaded:t.isFogLoaded});case v:return Object(u.a)(Object(u.a)({},e),{},{isFirstLoadDone:t.isFirstLoadDone});case w:return Object(u.a)(Object(u.a)({},e),{},{maps:t.maps,mapId:e.mapId?e.mapId:void 0});case x:var o=e.maps.length,r=n.concat(Object(u.a)(Object(u.a)({},t.map),{},{$id:o}));return Object(u.a)(Object(u.a)({},e),{},{maps:r,mapId:e.mapId?e.mapId:o,isFirstLoadDone:!0,isFogLoaded:!0});case S:var i=n.filter((function(e){return e.$id!==parseInt(t.mapId)}));return Object(u.a)(Object(u.a)({},e),{},{maps:i,mapId:parseInt(t.mapId)===e.mapId?void 0:e.mapId});case k:return Object(u.a)(Object(u.a)({},e),{},{tokens:t.tokens});case y:return Object(u.a)(Object(u.a)({},e),{},{tokens:e.tokens.concat(t.token)});case C:var s=a.filter((function(e){return e.guid!==t.tokenGuid}));return Object(u.a)(Object(u.a)({},e),{},{tokens:s});case T:var c=e.tokens.filter((function(e){return e.guid===t.tokenGuid}));return c.guid=W(),Object(u.a)(Object(u.a)({},e),{},{tokens:e.tokens.concat(c)});case E:var l=e.tokens.map((function(e){return e.guid!==t.tokenGuid?e:Object(u.a)(Object(u.a)({},e),{},Object(H.a)({},t.key,t.value))}));return Object(u.a)(Object(u.a)({},e),{},{tokens:l});case I:var d=e.tokens.map((function(e){return e.guid!==t.tokenGuid?e:Object(u.a)(Object(u.a)({},e),{},Object(H.a)({},t.key,!e[t.key]))}));return Object(u.a)(Object(u.a)({},e),{},{tokens:d});case N:var g=e.maps.map((function(t){return t.$id===e.mapId?Object(u.a)(Object(u.a)({},t),{},{fogPaths:[]}):t}));return Object(u.a)(Object(u.a)({},e),{},{maps:g});case P:var p=e.maps.map((function(t){return t.$id===e.mapId?Object(u.a)(Object(u.a)({},t),{},{drawPaths:[]}):t}));return Object(u.a)(Object(u.a)({},e),{},{maps:p});default:return e}},B=n(4),q=function(){return Object(a.useContext)(oe)},Z=function(e,t){e&&e.readyState===WebSocket.OPEN?e.send(JSON.stringify(t)):console.error("no websocket")},Q=function(e,t,n,a){Z(e,Object(u.a)({type:"pushGameRefresh",from:t.guid,username:t.username,game:n},a))},ee=function(e,t){Z(e,{type:"requestRefresh",from:t.guid,username:t.username})},te=n(0);n(26).config();var ne=Object({NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0,REACT_APP_PORT:"8000",REACT_APP_DEBUG:"false"}).PORT||"8000",ae=function(e,t){console.log("creating websocket, room:",e,"guid:",t);var n=function(e,t){var n=window.location.host.replace(/:\d+$/,""),a=/https/.test(window.location.protocol)?"wss":"ws";return"".concat(a,"://").concat(n,":").concat(ne,"/").concat(e,"?guid=").concat(t)}(e,t);return console.log("connecting to: ",n),new WebSocket(n)},oe=Object(a.createContext)(ae("","")),re=Object(c.b)((function(e){return{metadata:e.metadata}}),void 0)((function(e){var t=e.children,n=e.metadata,o=Object(a.useState)({room:n.room,isHost:n.isHost,guid:W(),username:""}),r=Object(B.a)(o,2),i=r[0],s=r[1],c=Object(a.useState)(ae(i.room,i.guid)),u=Object(B.a)(c,2),l=u[0],d=u[1];return Object(a.useEffect)((function(){var e=function(){setTimeout((function(){d(ae(i.room,i.guid))}),2500)},t=function(){i.isHost||ee(l,i)};return l.addEventListener("close",e),l.addEventListener("open",t),function(){l.removeEventListener("close",e),l.removeEventListener("open",t)}}),[l,d,i]),Object(te.jsx)(oe.Provider,{value:[l,i,s],children:t})})),ie=function(e,t,n,a,o){return e&&0!==e.trim().length?new Promise((function(r,i){var s=a,c=new Image;c.onload=function(){var e=n.width,t=n.height;e||t?e?t||(t=e*c.height/c.width):e=t*c.width/c.height:(e=c.width,t=c.height),(o?o(e,t):Promise.resolve()).then((function(){s.drawImage(c,n.x||0,n.y||0,e,t),r(e,t)}))},c.onerror=function(e){console.error("Unable to draw image.",c.src),i("Unable to draw ".concat(t,"Url"))},c.src=e})):(o&&o(),Promise.resolve(n.width,n.height))},se=n(12),ce=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=Object(a.useRef)(null);return Object(a.useEffect)((function(){var t=o.current.getContext(n.context||"2d");e(t)}),[e]),o},ue=["id","draw","options"],le=function(e){var t=e.id,n=e.draw,a=(e.options,Object(se.a)(e,ue)),o=ce(n);return Object(te.jsx)("canvas",Object(u.a)({id:t,ref:o},a))},de={updateTokens:Y},ge=Object(c.b)((function(e){return{game:e.game}}),de)((function(e){var t=e.game,n=(e.updateTokens,t.maps?t.maps[t.mapId]:void 0);return Object(te.jsx)(le,{id:"background",onClick:function(e){},width:n?n.width:0,height:n?n.height:0,draw:function(e){n&&ie(n.imageUrl,n.name,n,e,null)}})})),pe=Object(c.b)((function(e){return{game:e.game}}),void 0)((function(e){var t=e.game,n=t.width,a=t.height,o=function(){if(0!==t.maps.length){var e=t.maps.filter((function(e){return parseInt(e.$id)===parseInt(t.mapId)}));return e.length>0?e[0]:t.maps[0]}}(),r=function(e,t){e.globalCompositeOperation="source-over",e.beginPath();for(var n=0;n<t.length;n++)e.lineCap="round",e.fillStyle=t[n].drawColor,e.lineWidth=t[n].drawSize,e.strokeStyle=t[n].drawColor,0===n?e.moveTo(t[n].x,t[n].y):e.lineTo(t[n].x,t[n].y)},i=function(e,t){e.globalCompositeOperation="destination-out",e.beginPath();for(var n=0;n<t.length;n++)e.lineCap="round",e.lineWidth=t[n].drawSize,0===n?e.moveTo(t[n].x,t[n].y):e.lineTo(t[n].x,t[n].y)};return Object(te.jsx)(le,{id:"drawing",className:"passthrough",width:n,height:a,draw:function(e){if(o&&e){e.beginPath(),e.clearRect(0,0,n,a);for(var t=0;t<o.drawPaths.length;t++){var s=o.drawPaths[t];switch(s.length>0?s[0].tool:""){case"draw":r(e,s);break;case"erease":i(e,s)}e.stroke()}}}})})),je=Object(c.b)((function(e){return{game:e.game,settings:e.settings,metadata:e.metadata}}),void 0)((function(e){var t=e.game,n=e.metadata,a=e.settings,o=n.isHost?a.fogOpacity:1,r=t.width,i=t.height,s=function(){if(0!==t.maps.length){var e=t.maps.filter((function(e){return parseInt(e.$id)===parseInt(t.mapId)}));return e.length>0?e[0]:t.maps[0]}}(),c=function(e,t){var n;e.beginPath(),e.globalCompositeOperation="destination-out";for(var a=0;a<t.length;a++)(n=e.createRadialGradient(t[a].x,t[a].y,t[a].r2||1,t[a].x,t[a].y,.75*t[a].r)).addColorStop(0,"rgba(0,0,0,255)"),n.addColorStop(1,"rgba(0,0,0,0)"),e.fillStyle=n,e.fillRect(t[a].x-t[a].r,t[a].y-t[a].r,t[a].x+t[a].r,t[a].y+t[a].r)};return Object(te.jsx)(le,{id:"fog",className:"passthrough",style:{opacity:o},width:r,height:i,draw:function(e){if(s&&e){e.beginPath(),e.globalCompositeOperation="destination-over",e.fillStyle="black",e.fillRect(0,0,r,i);for(var t=0;t<s.fogPaths.length;t++){var n=s.fogPaths[t];c(e,n),e.stroke()}}}})})),me=Object(c.b)((function(e){return{game:e.game}}),void 0)((function(e){var t=e.game,n=e.overlayRef,a=t.maps[t.mapId]||void 0,o=a?a.width:t.width,r=a?a.height:t.height,i=n;return Object(te.jsx)("canvas",{id:"overlay",ref:i,width:o,height:r})})),be=function(e){var t=e.divStyle,n=e.token,a=e.classes,o=e.imgStyle,r=(e.onMouseUp,e.onMouseDown);return Object(te.jsx)("div",{style:t,title:n.name,className:a.join(" "),onMouseDown:function(e){return r(e)},children:Object(te.jsx)("img",{src:n.url,alt:n.name||"",style:o})})},fe=Object(c.b)((function(e){return{game:e.game,settings:e.settings}}),{})((function(e){var t=e.token,n=e.isHost,a=e.game,o=e.settings;if(!t.url||!t.url.trim())return null;var r=["token",t.ko&&"dead",t.pc?"pc":"npc",t.$selected&&"selected",n&&!t.pc&&"grabbable"],i={left:t.x||0,top:t.y||0},s={width:t.width||void 0,height:t.height||void 0};return void 0===t.mapId||a.mapId===t.mapId?Object(te.jsx)(be,{divStyle:i,token:t,classes:r,imgStyle:s,onMouseDown:function(e){o.tool}}):null})),he=function(e){var t=e.cursor,n=e.size,a=e.name,o={top:t.y,left:t.x},r={fontSize:n||void 0};return Object(te.jsxs)("div",{style:o,className:"cursor",children:[Object(te.jsx)("span",{role:"img","aria-label":"pointer",style:r,children:"\ud83d\udde1"}),t.u||a]})};var Oe=function(e){var t=e.title,n=e.value,a=e.onClick,o=e.isSelected,r=e.style,i=e.disabled;return Object(te.jsx)("button",{title:t,onClick:a,className:o?"selected":null,style:r,disabled:i,children:Object(te.jsx)("span",{role:"img","aria-label":t,children:n})})};var ve=function(e){var t=e.controlPanelState,n=e.setControlPanelState,a=e.title,o=e.value,r="toggleOn".concat(a),i=t[r];return Object(te.jsx)(Oe,{title:a,value:o,onClick:function(){n(Object(u.a)(Object(u.a)({},t),{},Object(H.a)({},r,!t[r])))},isSelected:i})},we=function(e){var t=e.tool,n=e.subtool,a=e.drawColor,o=e.setDrawColor,r=e.drawSize,i=e.setDrawSize,s=e.fogOpacity,c=e.setFogOpacity,u=e.fogRadius,l=e.setFogRadius,d=e.setSubtool,g=e.resetFog,p=e.resetDrawing;switch(t){case"draw":return Object(te.jsxs)("span",{children:[Object(te.jsx)(Oe,{title:"eraser",value:"\ud83e\uddfd",onClick:function(){return d("eraser")},isSelected:"eraser"===n}),Object(te.jsx)(Oe,{title:"pencil",value:"\ud83d\udd8d",onClick:function(){return d("pencil")},isSelected:"pencil"===n}),Object(te.jsx)("input",{size:"3",title:"draw size",value:r,onChange:function(e){return i(e.target.value)},type:"number",step:"3",min:"1"}),Object(te.jsx)("input",{size:"3",title:"draw color",value:a,onChange:function(e){return o(e.target.value)}}),Object(te.jsx)(Oe,{style:{backgroundColor:a},value:"\ud83d\udd8c",disabled:!0}),Object(te.jsx)(Oe,{title:"reset drawing",onClick:p,value:"\ud83c\udf00"})]});case"move":return null;case"fog":return Object(te.jsxs)("span",{children:[Object(te.jsx)(Oe,{title:"reset fog",onClick:g,value:"\ud83c\udf00"}),Object(te.jsx)("input",{size:"3",title:"fog radius",value:u,onChange:function(e){return l(e.target.value)},type:"number",step:"5",min:"1"}),Object(te.jsx)("input",{size:"3",title:"fog opacity",step:"0.05",min:"0",max:"1",value:s,onChange:function(e){return c(e.target.value)},type:"number"})]});default:return null}},xe={setToolSettings:U,setDrawToolSettings:function(e,t){return{type:g,drawColor:e,drawSize:parseInt(t)}},setFogToolSettings:function(e,t){return{type:d,fogOpacity:e,fogRadius:parseInt(t)}},resetFog:function(){return{type:N}},resetDraw:function(){return{type:P}}},Se=Object(c.b)((function(e){return{settings:e.settings}}),xe)((function(e){var t=e.settings,n=e.setToolSettings,a=e.setDrawToolSettings,o=e.setFogToolSettings,r=e.resetFog,i=e.resetDraw;return Object(te.jsx)("span",{children:Object(te.jsx)(we,{tool:t.tool,subtool:t.subtool,drawColor:t.drawColor,setDrawColor:function(e){a(e,t.drawSize)},drawSize:t.drawSize,setDrawSize:function(e){var n=e;isNaN(n)||a(t.drawColor,n)},fogOpacity:t.fogOpacity,setFogOpacity:function(e){var n=e;isNaN(n)||o(n,t.fogRadius)},fogRadius:t.fogRadius,setFogRadius:function(e){var n=e;isNaN(n)||o(t.fogOpacity,n)},setSubtool:function(e){n(t.tool,e)},resetFog:function(){r()},resetDrawing:function(){i()}})})})),ke=function(e){var t=e.isSelected,n=e.mapConfigState,a=e.load,o=e.onTextChange,r=e.onIntegerChange,i=e.deleteMap;return Object(te.jsxs)("div",{className:t?"selected":null,children:[n.name,Object(te.jsx)("input",{value:n.imageUrl||"",placeholder:"Map url",size:"8",onChange:function(e){return o("imageUrl",e)}}),"w:",Object(te.jsx)("input",{value:n.width||0,placeholder:"width",className:"text3",onChange:function(e){return r("width",e)},type:"number",min:"0",step:"10",title:"width"}),"h:",Object(te.jsx)("input",{value:n.height||0,placeholder:"height",className:"text3",onChange:function(e){return r("height",e)},type:"number",min:"0",step:"10",title:"height"}),Object(te.jsx)(Oe,{title:"Save & load map",value:"\ud83d\udcc0",onClick:a}),Object(te.jsx)(Oe,{title:"Delete map",value:"\ud83d\uddd1",onClick:i})]})},ye={loadMap:V,updateMaps:K,deleteMap:function(e){return{type:S,mapId:e}},setIsFogLoaded:function(e){return{type:O,isFogLoaded:e}},setIsFirstLoadDone:function(e){return{type:v,isFirstLoadDone:e}}},Ce=Object(c.b)((function(e){return{game:e.game}}),ye)((function(e){var t=e.map,n=e.game,o=e.loadMap,r=e.updateMaps,i=e.deleteMap,s=e.setIsFogLoaded,c=e.setIsFirstLoadDone,l=Object(a.useState)(function(e,t){var n=t.maps.filter((function(t){return t.$id===e.$id}))||{name:void 0,url:void 0,w:void 0,h:void 0};return{$id:parseInt(e.$id),name:n.name?n.name:e.name,imageUrl:n.imageUrl?n.imageUrl:"",width:n.width?n.width:window.innerWidth,height:n.height?n.height:window.innerHeight,x:0,y:0}}(t,n)),d=Object(B.a)(l,2),g=d[0],p=d[1],j=q(),m=Object(B.a)(j,2),b=m[0],f=m[1],h=n.mapId===t.$id;return t?Object(te.jsx)(ke,{isSelected:h,mapConfigState:g,load:function(){var e=n.maps.map((function(e){return t.$id===e.$id?Object(u.a)(Object(u.a)({},e),{},{imageUrl:g.imageUrl,width:g.width,height:g.height}):e}));r(e),o(t.$id),s(!0),c(!0),function(e,t,n){Z(e,{type:"pushMapId",from:t.guid,username:t.username,mapId:n})}(b,f,t.$id)},onTextChange:function(e,t){p(Object(u.a)(Object(u.a)({},g),{},Object(H.a)({},e,t.target.value)))},onIntegerChange:function(e,t){var n=parseInt(t.target.value)||void 0;p(Object(u.a)(Object(u.a)({},g),{},Object(H.a)({},e,n)))},deleteMap:function(){window.confirm("Delete map?")&&i(t.$id)}}):null})),Te=function(e){var t=e.maps,n=e.newMapName,a=e.setNewMapName,o=e.createMap;return Object(te.jsxs)("div",{children:[Object(te.jsx)("hr",{}),Object(te.jsxs)("div",{children:[Object(te.jsx)("input",{placeholder:"New map name",onChange:function(e){return a(e.target.value)},value:n}),Object(te.jsx)(Oe,{title:"Create new map",value:"\u2795",onClick:o,disabled:""===n}),t.map((function(e){return Object(te.jsx)(Ce,{map:e},"map".concat(e.$id))}))]})]})},Ee={addMap:function(e,t,n){return{type:x,map:{name:e,$id:0,imageUrl:"",x:0,y:0,width:t,height:n,drawPaths:[],fogPaths:[]}}}},Ie=Object(c.b)((function(e){return{game:e.game}}),Ee)((function(e){var t=e.toggleOnMaps,n=e.game,o=e.addMap,r=Object(a.useState)(""),i=Object(B.a)(r,2),s=i[0],c=i[1],u=n.maps;return t?Object(te.jsx)(Te,{maps:u,newMapName:s,setNewMapName:c,createMap:function(){o(s,window.innerWidth,window.innerHeight),c("")}}):null})),Ne=function(e){var t=e.maps,n=e.token,a=e.copy,o=e.onToggle,r=e.selectToken,i=e.onTextChange,s=e.onIntegerChange,c=e.onMapSelect,u=e.deleteToken;return Object(te.jsxs)("div",{className:"tokenConfig",children:[Object(te.jsx)(Oe,{title:"Duplicate token",value:"\ud83d\udc6f",onClick:a}),Object(te.jsx)(Oe,{value:n.pc?"\ud83d\udda5":"\ud83d\udc64",onClick:function(e){return o("pc",e)},title:"pc/npc"}),Object(te.jsx)(Oe,{value:n.$selected?"\u2705":"\u274c",onClick:function(e){return r(n,e)},title:"(un)select"}),Object(te.jsx)(Oe,{value:n.ko?"\ud83e\udd40":"\ud83c\udf39",onClick:function(e){return o("ko",e)},title:"alive/dead"}),Object(te.jsx)("input",{value:n.name||"",placeholder:"Name",size:"8",onChange:function(e){return i("name",e)}}),Object(te.jsx)("input",{value:n.url||"",placeholder:"Url",size:"8",onChange:function(e){return i("url",e)}}),"wh:",Object(te.jsx)("input",{value:n.width||"",placeholder:"w",className:"text2",onChange:function(e){return s("width",e)},type:"number",step:"5",min:"0",title:"width"}),Object(te.jsx)("input",{value:n.height||"",placeholder:"h",className:"text2",onChange:function(e){return s("height",e)},type:"number",step:"5",min:"0",title:"height"}),"xy:",Object(te.jsx)("input",{value:n.x||"",placeholder:"x",className:"text3",onChange:function(e){return s("x",e)},type:"number",step:"5",title:"x coord"}),Object(te.jsx)("input",{value:n.y||"",placeholder:"y",className:"text3",onChange:function(e){return s("y",e)},type:"number",step:"5",title:"y coord"}),Object(te.jsxs)("select",{defaultValue:n.mapId,onChange:function(e){return c(e)},title:"which map",children:[Object(te.jsx)("option",{value:-1,children:"(all)"},-1),t.map((function(e){return Object(te.jsx)("option",{value:e.name,children:t.name},e.$id)}))]}),Object(te.jsx)(Oe,{title:"Delete token",value:"\ud83d\uddd1",onClick:u})]})},Pe=function(e){var t=e.token,n=e.onTextChange,a=e.onIntegerChange;return Object(te.jsxs)("div",{className:"tokenConfig",children:[Object(te.jsx)("input",{value:t.name||"",placeholder:"Name",size:"8",onChange:function(e){return n("name",e)}}),Object(te.jsx)("input",{value:t.url||"",placeholder:"Url",size:"8",onChange:function(e){return n("url",e)}}),"wh:",Object(te.jsx)("input",{value:t.width||"",placeholder:"w",className:"text2",onChange:function(e){return a("width",e)},type:"number",step:"5",min:"0",title:"width"}),Object(te.jsx)("input",{value:t.height||"",placeholder:"h",className:"text2",onChange:function(e){return a("height",e)},type:"number",step:"5",min:"0",title:"height"}),"xy:",Object(te.jsx)("input",{value:t.x||"",placeholder:"x",className:"text3",onChange:function(e){return a("x",e)},type:"number",step:"5",title:"x coord"}),Object(te.jsx)("input",{value:t.y||"",placeholder:"y",className:"text3",onChange:function(e){return a("y",e)},type:"number",step:"5",title:"y coord"})]})},Me={deleteToken:function(e){return{type:C,tokenGuid:e}},copyToken:function(e){return{type:T,tokenGuid:e}},updateTokenValue:function(e,t,n){return{type:E,tokenGuid:e,key:t,value:n}},toggleTokenValue:function(e,t){return{type:I,tokenGuid:e,key:t}},updateTokens:Y},Re=Object(c.b)((function(e){return{game:e.game,metadata:e.metadata}}),Me)((function(e){var t=e.token,n=e.game,a=e.metadata,o=e.deleteToken,r=e.copyToken,i=e.updateTokenValue,s=e.toggleTokenValue,c=function(e,n){i(t.guid,e,parseInt(n.target.value)||void 0)},l=function(e,n){i(t.guid,e,n.target.value)};return Object(te.jsx)("div",{children:t?a.isHost?Object(te.jsx)(Ne,{maps:n.maps,token:t,copy:function(){r(t.guid)},onToggle:function(e){s(t.guid,e)},selectToken:function(e,t){if(e.pc||a.isHost){var o=n.tokens.map((function(n){return n.guid===e.guid?Object(u.a)(Object(u.a)({},n),{},{$selected:t||!n.$selected,$x0:n.x,$y0:n.y}):n}));Y(o)}},onTextChange:l,onIntegerChange:c,onMapSelect:function(e){var n=parseInt(e.target.value);n<0&&(n=void 0),i(t.guid,"mapId",n)},deleteToken:function(){o(t.guid)}}):Object(te.jsx)(Pe,{token:t,onTextChange:l,onIntegerChange:c}):null})})),Ae=function(e){var t=e.newTokenUrl,n=e.setNewTokenUrl,a=e.createToken,o=e.tokens;return Object(te.jsxs)("div",{children:[Object(te.jsx)("hr",{}),Object(te.jsx)("input",{placeholder:"New token url",onChange:function(e){return n(e.target.value)},value:t}),Object(te.jsx)(Oe,{title:"Create new token",value:"\u2795",onClick:a}),o.map((function(e,t){return Object(te.jsx)(Re,{token:e},"token".concat(t))}))]})},De=function(e){var t=e.tokens.filter((function(e){return e.$selected}));return Object(te.jsx)("div",{children:t.map((function(e,t){return Object(te.jsx)(Re,{token:e},"token".concat(t))}))})},Ge=Object(c.b)((function(e){return{game:e.game}}),void 0)((function(e){var t=e.game.tokens.filter((function(e){return e.$selected}));return Object(te.jsx)(De,{tokens:t})})),ze={addToken:function(e,t,n){var a={guid:W(),name:e,url:t,mapId:n,$selected:void 0,$x0:0,$y0:0,x:0,y:0,ko:void 0,pc:void 0,w:0,h:0};return{type:y,token:a}}},Ue=Object(c.b)((function(e){return{game:e.game,metadata:e.metadata}}),ze)((function(e){var t=e.toggleOnTokens,n=e.game,o=e.addToken,r=e.metadata,i=Object(a.useState)(""),s=Object(B.a)(i,2),c=s[0],u=s[1];if(!r.isHost)return null;return t?Object(te.jsx)(Ae,{newTokenUrl:c,setNewTokenUrl:u,createToken:function(){c&&(o(void 0,c,n.mapId),u(""))},tokens:n.tokens}):Object(te.jsx)(Ge,{tokens:n.tokens})})),Le=function(e){var t=e.initAsDev,n=e.copyJson,a=e.pasteJson,o=e.username,r=e.updateUsername,i=e.cursorSize,s=e.updateCursorSize;return Object(te.jsxs)("div",{children:[Object(te.jsx)("hr",{}),Object(te.jsx)("input",{title:"User name",placeholder:"User name",value:o,onChange:function(e){return r(e.target.value)}}),Object(te.jsx)("input",{title:"Cursor size",value:i,onChange:function(e){return s(e.target.value)},type:"number",min:"0"}),Object(te.jsx)("hr",{}),Object(te.jsx)(Oe,{title:"Redo as dev",value:"\ud83d\udd30",onClick:t}),Object(te.jsx)(Oe,{title:"Copy JSON to clipboard",value:"\ud83d\udc6f",onClick:n}),Object(te.jsx)(Oe,{title:"Paste JSON from clipboard",value:"\ud83d\udccb",onClick:a})]})},_e={setUsername:L,setCursorSize:z},$e=Object(c.b)((function(e){return{game:e.game,settings:e.settings}}),_e)((function(e){var t=e.toggleOnUser,n=e.settings,a=e.setUsername,o=e.setCursorSize,r=q(),i=Object(B.a)(r,3),s=(i[0],i[1]),c=i[2];if(!t)return null;return t?Object(te.jsx)(Le,{initAsDev:function(){},copyJson:function(){},pasteJson:function(){},username:n.username,updateUsername:function(e){a(e),c(Object(u.a)(Object(u.a)({},s),{},{username:e}))},cursorSize:n.cursorSize,updateCursorSize:function(e){var t=e;isNaN(t)||o(t)}}):null}));var Fe={setToolSettings:U},He=Object(c.b)((function(e){return{settings:e.settings}}),Fe)((function(e){var t=e.title,n=e.value,a=e.settings,o=e.setToolSettings,r=t===a.tool;return Object(te.jsx)(Oe,{title:t,value:n.toString(),onClick:function(){o(t,void 0)},isSelected:r})})),We=function(){return Object(te.jsxs)("span",{id:"tools",children:[Object(te.jsx)(He,{title:"move",value:"\ud83e\uddf3"}),Object(te.jsx)(He,{title:"draw",value:"\ud83d\udd8d"}),Object(te.jsx)(He,{title:"fog",value:"\ud83c\udf2c"})]})},Je=function(e){var t=e.controlPanelState,n=e.setControlPanelState,a=e.hidden,o=e.toggleHidden,r=e.isHost,i=e.username,s=e.setUsername,c=e.cursorSize,u=e.setCursorSize,l=e.socketRequestRefresh,d=e.pushRefreshToPlayers;return a?Object(te.jsxs)("div",{id:"control-panel",children:["\xa0\xa0\xa0\xa0",Object(te.jsx)(Oe,{value:"\ud83d\udc41",onClick:o,title:"show/hide control panel"}),"\xa0\xa0\xa0\xa0"]}):r?Object(te.jsxs)("div",{id:"control-panel",children:["\xa0\xa0\xa0\xa0",Object(te.jsx)(Oe,{value:"\ud83d\udc41",onClick:o,title:"show/hide control panel"}),"\xa0\xa0\xa0\xa0",Object(te.jsx)(ve,{title:"User",value:"\ud83e\uddd9\u200d\u2642\ufe0f",controlPanelState:t,setControlPanelState:n}),Object(te.jsx)(ve,{title:"Maps",value:"\ud83d\uddfa",controlPanelState:t,setControlPanelState:n}),Object(te.jsx)(ve,{title:"Tokens",value:"\u265f",controlPanelState:t,setControlPanelState:n}),Object(te.jsx)(Oe,{title:"Push refresh to players",value:"\ud83d\udcab",onClick:d}),"\xa0\xa0\xa0\xa0",Object(te.jsx)(We,{}),"\xa0\xa0\xa0\xa0",Object(te.jsx)(Se,{}),Object(te.jsx)(Ie,{toggleOnMaps:t.toggleOnMaps}),Object(te.jsx)(Ue,{toggleOnTokens:t.toggleOnTokens}),Object(te.jsx)($e,{toggleOnUser:t.toggleOnUser})]}):Object(te.jsxs)("div",{id:"control-panel",children:[Object(te.jsx)(Oe,{value:"\ud83d\udc41",onClick:o,title:"show/hide control panel"}),Object(te.jsx)("input",{title:"User name",placeholder:"User name",value:i,onChange:function(e){return s(e.target.value)}}),Object(te.jsx)(ve,{title:"Share mouse (cursor)",value:"\ud83d\udc01",controlPanelState:t,setControlPanelState:n}),Object(te.jsx)("input",{title:"Cursor size",value:c,onChange:function(e){return u(parseInt(e.target.value))},type:"number",min:"0"}),Object(te.jsx)(Oe,{title:"Request gameboard refresh from host",onClick:l,value:"\ud83d\udcab"}),Object(te.jsx)(Ge,{})]})},Ve=function(){return{hidden:!1,toggleOnMaps:!1,toggleOnUser:!1,toggleOnTokens:!1}},Ke={setUsername:L,setCursorSize:z},Ye=Object(c.b)((function(e){return{game:e.game,settings:e.settings,metadata:e.metadata}}),Ke)((function(e){var t=e.game,n=e.settings,o=e.metadata,r=e.setUsername,i=e.setCursorSize,s=Object(a.useState)(Ve),c=Object(B.a)(s,2),l=c[0],d=c[1],g=q(),p=Object(B.a)(g,3),j=p[0],m=p[1],b=p[2];return Object(te.jsx)(Je,{controlPanelState:l,setControlPanelState:d,hidden:l.hidden,toggleHidden:function(){d(Object(u.a)(Object(u.a)({},l),{},{hidden:!l.hidden}))},isHost:o.isHost,username:n.username,setUsername:function(e){r(e),b(Object(u.a)(Object(u.a)({},m),{},{username:e}))},cursorSize:n.cursorSize,setCursorSize:function(e){var t=e;isNaN(t)||i(t)},socketRequestRefresh:function(){ee(j,m)},pushRefreshToPlayers:function(){console.log("pushing game",t),Q(j,m,t)}})})),Xe=function(e){var t=e.isHost,n=e.overlayRef,a=e.isFogLoaded,o=e.cursors,r=e.cursorSize,i=e.tokens,s=e.onMouseMove,c=e.onMouseUp,u=e.onMouseDown,l=a?null:"gone";return Object(te.jsxs)("div",{id:"game",onMouseMove:function(e){return s(e)},onMouseDown:function(e){return u(e)},onMouseUp:function(e){return c(e)},children:[Object(te.jsxs)("div",{className:l,children:[Object(te.jsx)(ge,{}),Object(te.jsx)(pe,{}),i?Object(te.jsx)("div",{id:"tokens",children:i.map((function(e,n){return Object(te.jsx)(fe,{token:e,isHost:t},"Token".concat(n))}))}):null,Object(te.jsx)(je,{}),o?Object(te.jsx)("div",{id:"cursors",children:o.map((function(e){return Object(te.jsx)(he,{name:e.username,cursor:e,size:r},"cursor".concat(e.$id))}))}):null,Object(te.jsx)(me,{overlayRef:n})]}),Object(te.jsx)(Ye,{})]})},Be={setGameSettings:function(e,t){return{type:M,isHost:e,room:t}},overwriteGame:function(e){return{type:b,game:e}},loadMap:V,updateMaps:K,incrementGen:function(){return{type:h}}},qe=Object(c.b)((function(e){return{metadata:e.metadata,game:e.game,settings:e.settings}}),Be)((function(e){var t=e.metadata,n=e.game,r=e.settings,i=e.setGameSettings,s=e.overwriteGame,c=e.loadMap,l=e.updateMaps,d=(e.incrementGen,o.a.useRef()),g=q(),p=Object(B.a)(g,2),j=p[0],m=p[1],b=[],f=function(){if(0!==n.maps.length){var e=n.maps.filter((function(e){return e.$id===n.mapId}));return e.length>0?e[0]:n.maps[0]}},h=function(e,t,n,a){if(null!=n){var o=d.current.getContext("2d");o.strokeStyle=n,o.lineWidth="3",o.beginPath(),o.arc(e,t,a,0,2*Math.PI),o.stroke(),o.closePath()}},O=function(){},v=function(e){},w=function(){var e="eraser"===r.subtool;switch(r.tool){case"draw":return e?"erease":"draw";default:return r.tool}},x=function(e){var a=JSON.parse(e.data);if(console.log("receiving the following data",a),a.from!==m.guid&&(!a.to||a.to===m.guid)){var o=f();switch(console.log("current map",o),a.type){case"pushCursor":break;case"pushDrawPath":var r=o.drawPaths?o.drawPaths:[];r.push(a.drawPath);var i=n.maps.map((function(e){return e.$id===o.$id?Object(u.a)(Object(u.a)({},o),{},{drawPaths:r}):e}));l(i);break;case"pushDrawReset":var d=n.maps.map((function(e){return e.$id===o.$id?Object(u.a)(Object(u.a)({},o),{},{drawPaths:[]}):e}));l(d);break;case"pushFogPath":var g=o.fogPaths?o.fogPaths:[];g.push(a.fogPath);var p=n.maps.map((function(e){return e.$id===o.$id?Object(u.a)(Object(u.a)({},o),{},{fogPaths:g}):e}));l(p);break;case"pushFogReset":var b=n.maps.map((function(e){return e.$id===o.$id?Object(u.a)(Object(u.a)({},o),{},{fogPaths:[]}):e}));l(b);break;case"pushSingleToken":case"pushTokens":break;case"pushMapId":c(a.mapId);break;case"pushMapState":l(a.maps),c(a.mapId);break;case"pushGameRefresh":console.log("receiving gamedata",a.game),s(a.game);break;case"requestRefresh":t.isHost&&Q(j,m,n,{to:a.from});break;default:console.error("Unrecognized websocket message type: ".concat(a.type))}}},S=function(){};Object(a.useEffect)((function(){window.addEventListener("beforeunload",S),window.addEventListener("resize",O),window.addEventListener("keydown",v);var e=new URLSearchParams(window.location.href.replace(/.*\?/,""));return i(e.get("host"),e.get("room")),function(){window.removeEventListener("beforeunload",S),window.removeEventListener("resize",O),window.removeEventListener("keydown",v)}}),[]),Object(a.useEffect)((function(){return j&&j.addEventListener("message",x),document.title="Borealis D&D, Room: ".concat(t.room),function(){j.removeEventListener("message",x)}}),[t.room,j,x]);var k=new Date-3e4,y=t.cursors;for(var C in y){var T=y[C].time;(!T||T<k)&&delete y[C]}try{return Object(te.jsx)(Xe,{isHost:t.isHost,overlayRef:d,isFogLoaded:n.isFogLoaded,cursors:y,cursorSize:r.cursorSize,tokens:n.tokens,onMouseMove:function(e){if(d){!function(){var e=d.current.getContext("2d");e&&e.clearRect(0,0,n.width,n.height)}();var a=e.pageX,o=e.pageY;switch(t.isHost?r.tool:"move"){case"fog":!function(){var e,t=d.current.getContext("2d");t.beginPath();for(var n=0;n<b.length;n++)e=t.createRadialGradient(b[n].x,b[n].y,b[n].r2||1,b[n].x,b[n].y,.75*b[n].r),t.lineCap="round",e.addColorStop(0,"rgba(255,255,255,255)"),e.addColorStop(1,"rgba(255,255,255,0)"),t.fillStyle=e,t.fillRect(b[n].x-b[n].r,b[n].y-b[n].r,b[n].x+b[n].r,b[n].y+b[n].r);t.stroke()}(),h(a,o,"yellow",r.fogRadius);break;case"draw":!function(){var e=d.current.getContext("2d");e.beginPath();for(var t=0;t<b.length;t++)e.lineCap="round",e.fillStyle=b[t].drawColor,e.lineWidth=b[t].drawSize,e.strokeStyle=b[t].drawColor,0===t?e.moveTo(b[t].x,b[t].y):e.lineTo(b[t].x,b[t].y);e.stroke()}(),h(a,o,r.drawColor,r.drawSize);break;case"move":e.buttons}("fog"===r.tool||"draw"===r.tool)&&1&e.buttons&&b.push({x:a,y:o,r:r.fogRadius,r2:void 0,tool:w(),drawColor:r.drawColor,drawSize:r.drawSize})}},onMouseUp:function(e){var a=f();if(a&&t.isHost){var o=a.fogPaths,i=a.drawPaths;switch(r.tool){case"fog":o.push(b),function(e,t,n){Z(e,{type:"pushFogPath",from:t.guid,username:t.username,fogPath:n})}(j,m,b);break;case"draw":i.push(b),function(e,t,n){Z(e,{type:"pushDrawPath",from:t.guid,username:t.username,drawPath:n})}(j,m,b)}b=[];var s=n.maps.map((function(e){return e.$id===a.$id?Object(u.a)(Object(u.a)({},a),{},{fogPaths:o,drawPaths:i}):e}));l(s)}},onMouseDown:function(e){for(var n=0,a=[document.activeElement,e.target];n<a.length;n++){var o=a[n];if("INPUT"==o.tagName&&("text"===o.type||"number"===o.type)||"BUTTON"==o.tagName)return e}t.isHost&&1&e.buttons&&(b=[]).push({x:e.pageX,y:e.pageY,r:r.fogRadius,r2:void 0,tool:w(),drawColor:r.drawColor,drawSize:r.drawSize})}})}catch(E){!function(e){console.error(e),console.error("Exception in `render`. Clearing localStorage..."),localStorage.removeItem(t.room),window.alert("Fatal error. Local storage cleared.")}(E)}})),Ze=function(){var e=Object(s.a)({settings:_,metadata:F,game:X}),t=Object(s.b)(e);return Object(te.jsx)(c.a,{store:t,children:Object(te.jsx)(re,{children:Object(te.jsx)(qe,{})})})};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(Object(te.jsx)(o.a.StrictMode,{children:Object(te.jsx)(Ze,{})}),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[30,1,2]]]);
//# sourceMappingURL=main.e90d6576.chunk.js.map
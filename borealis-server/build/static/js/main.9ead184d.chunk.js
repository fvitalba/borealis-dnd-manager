(this["webpackJsonpborealis-webclient"]=this["webpackJsonpborealis-webclient"]||[]).push([[0],{17:function(e,t,n){},18:function(e,t,n){},30:function(e,t,n){"use strict";n.r(t);var a=n(2),o=n.n(a),r=n(6),i=n.n(r),s=(n(17),n(18),n(9)),c=n(3),u=n(1),l="SETTINGS/CHANGE_CURSORSIZE",d="SETTINGS/CHANGE_FOG_SETTINGS",g="SETTINGS/CHANGE_DRAW_SETTINGS",p="SETTINGS/CHANGE_TOOL",b="SETTINGS/CHANGE_USERNAME",j="SETTINGS/TOGGLE_MOUSESHARING",f="GAME/OVERWRITE_GAME",m="GAME/LOAD_MAP",h="GAME/INCREMENT_GEN",O="GAME/SET_FOG_ENABLED",v="GAME/SET_ISFOGLOADED",w="GAME/SET_ISFIRSTLOADDONE",x="GAME/UPDATE_MAPS",S="GAME/ADD_MAP",k="GAME/DELETE_APP",y="GAME/UPDATE_TOKENS",C="GAME/ADD_TOKEN",E="GAME/DELETE_TOKEN",T="GAME/COPY_TOKEN",N="GAME/UPDATE_TOKEN_VALUE",I="GAME/TOGGLE_TOKEN_VALUE",M="GAME/RESET_FOG",P="GAME/RESET_DRAW",R="METADATA/SET_GAMESETTINGS",A="METADATA/SET_CURSORS",D="METADATA/SET_LAST_COORDINATES",G="METADATA/SET_DOWN_COORDINATES",z=function(){return{cursorSize:50,fogOpacity:.5,fogRadius:75,drawColor:"white",drawSize:8,tool:"move",subtool:void 0,username:new URLSearchParams(window.location.href.replace(/.*\?/,"")).get("host")?"DM":"PC",shareMouse:!0}},U=function(e){return{type:l,cursorSize:parseInt(e)}},L=function(e,t){return{type:p,tool:e,subtool:t}},F=function(e){return{type:b,username:e}},$=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:z(),t=arguments.length>1?arguments[1]:void 0;switch(t.type){case l:return Object(u.a)(Object(u.a)({},e),{},{cursorSize:t.cursorSize});case d:return Object(u.a)(Object(u.a)({},e),{},{fogOpacity:t.fogOpacity,fogRadius:t.fogRadius});case g:return Object(u.a)(Object(u.a)({},e),{},{drawColor:t.drawColor,drawSize:t.drawSize});case p:return Object(u.a)(Object(u.a)({},e),{},{tool:t.tool,subtool:t.subtool});case b:return Object(u.a)(Object(u.a)({},e),{},{username:t.username});case j:return Object(u.a)(Object(u.a)({},e),{},{shareMouse:!e.shareMouse});default:return e}},_={isHost:void 0,room:void 0,cursors:[],lastX:void 0,lastY:void 0,downX:void 0,downY:void 0},H=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case R:return Object(u.a)(Object(u.a)({},e),{},{isHost:t.isHost,room:t.room});case A:return Object(u.a)(Object(u.a)({},e),{},{cursors:t.cursors});case D:return Object(u.a)(Object(u.a)({},e),{},{lastX:t.lastX,lastY:t.lastY});case G:return Object(u.a)(Object(u.a)({},e),{},{downX:t.downX,downY:t.downY});default:return e}},W=n(5),J=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=window.crypto.getRandomValues(new Uint32Array(1))[0]*Math.pow(2,-32)*16|0;return("x"===e?t:3&t|8).toString(16)}))},V={mapId:void 0,gen:0,width:window.innerWidth,height:window.innerHeight,fogEnabled:!1,isFogLoaded:!1,isFirstLoadDone:!1,maps:[],tokens:[]},K=function(e){return{type:m,mapId:parseInt(e)}},Y=function(e){return{type:O,fogEnabled:e}},X=function(e){return{type:x,maps:e}},B=function(e,t,n){return{type:S,map:{name:e,$id:0,imageUrl:"",x:0,y:0,width:t,height:n,drawPaths:[],fogPaths:[]}}},q=function(e){return{type:y,tokens:e}},Z=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:V,t=arguments.length>1?arguments[1]:void 0,n=JSON.parse(JSON.stringify(e.maps)),a=JSON.parse(JSON.stringify(e.tokens));switch(t.type){case f:return Object(u.a)(Object(u.a)({},e),t.game);case m:return Object(u.a)(Object(u.a)({},e),{},{mapId:parseInt(t.mapId)});case h:return Object(u.a)(Object(u.a)({},e),{},{gen:e.gen+1});case O:return Object(u.a)(Object(u.a)({},e),{},{fogEnabled:t.fogEnabled});case v:return Object(u.a)(Object(u.a)({},e),{},{isFogLoaded:t.isFogLoaded});case w:return Object(u.a)(Object(u.a)({},e),{},{isFirstLoadDone:t.isFirstLoadDone});case x:return Object(u.a)(Object(u.a)({},e),{},{maps:t.maps,mapId:isNaN(e.mapId)?void 0:e.mapId});case S:var o=e.maps.length,r=n.concat(Object(u.a)(Object(u.a)({},t.map),{},{$id:o}));return Object(u.a)(Object(u.a)({},e),{},{maps:r,mapId:isNaN(e.mapId)?o:e.mapId,isFirstLoadDone:!0,isFogLoaded:!0});case k:var i=n.filter((function(e){return e.$id!==parseInt(t.mapId)}));return Object(u.a)(Object(u.a)({},e),{},{maps:i,mapId:parseInt(t.mapId)===e.mapId?void 0:e.mapId});case y:return Object(u.a)(Object(u.a)({},e),{},{tokens:t.tokens});case C:return Object(u.a)(Object(u.a)({},e),{},{tokens:e.tokens.concat(t.token)});case E:var s=a.filter((function(e){return e.guid!==t.tokenGuid}));return Object(u.a)(Object(u.a)({},e),{},{tokens:s});case T:var c=e.tokens.filter((function(e){return e.guid===t.tokenGuid}));return c.guid=J(),Object(u.a)(Object(u.a)({},e),{},{tokens:e.tokens.concat(c)});case N:var l=e.tokens.map((function(e){return e.guid!==t.tokenGuid?e:Object(u.a)(Object(u.a)({},e),{},Object(W.a)({},t.key,t.value))}));return Object(u.a)(Object(u.a)({},e),{},{tokens:l});case I:var d=e.tokens.map((function(e){return e.guid!==t.tokenGuid?e:Object(u.a)(Object(u.a)({},e),{},Object(W.a)({},t.key,!e[t.key]))}));return Object(u.a)(Object(u.a)({},e),{},{tokens:d});case M:var g=e.maps.map((function(t){return t.$id===e.mapId?Object(u.a)(Object(u.a)({},t),{},{fogPaths:[]}):t}));return Object(u.a)(Object(u.a)({},e),{},{maps:g});case P:var p=e.maps.map((function(t){return t.$id===e.mapId?Object(u.a)(Object(u.a)({},t),{},{drawPaths:[]}):t}));return Object(u.a)(Object(u.a)({},e),{},{maps:p});default:return e}},Q=n(4),ee=function(){return Object(a.useContext)(ie)},te=function(e,t){e&&e.readyState===WebSocket.OPEN?e.send(JSON.stringify(t)):console.error("no websocket")},ne=function(e,t,n,a){te(e,Object(u.a)({type:"pushGameRefresh",from:t.guid,username:t.username,game:n},a))},ae=function(e,t){te(e,{type:"requestRefresh",from:t.guid,username:t.username})},oe=n(0);n(26).config();Object({NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0,REACT_APP_PORT:"8000"}).PORT;var re=function(e,t){if(e){var n=function(e,t){var n=window.location.host.replace(/:\d+$/,""),a=/https/.test(window.location.protocol)?"wss":"ws";return"".concat(a,"://").concat(n,"/").concat(e,"?guid=").concat(t)}(e,t);return new WebSocket(n)}},ie=Object(a.createContext)(re("","")),se=Object(c.b)((function(e){return{metadata:e.metadata}}),void 0)((function(e){var t=e.children,n=e.metadata,o=Object(a.useState)({guid:J(),username:""}),r=Object(Q.a)(o,2),i=r[0],s=r[1],c=Object(a.useState)(re(n.room,i.guid)),u=Object(Q.a)(c,2),l=u[0],d=u[1];return Object(a.useEffect)((function(){d(re(n.room,i.guid))}),[n.room,i.guid]),Object(a.useEffect)((function(){var e=function(){setTimeout((function(){console.log("Socket Timeout, recreating WebSocket"),d(re(n.room,i.guid))}),2500)},t=function(){n.isHost||ae(l,i)},a=function(e){console.error("WebSocket could not be created. Error: ",e)};return l&&(l.addEventListener("close",e),l.addEventListener("open",t),l.addEventListener("error",a)),function(){l&&(l.removeEventListener("close",e),l.removeEventListener("open",t),l.removeEventListener("error",a))}}),[l,d,i,n]),Object(oe.jsx)(ie.Provider,{value:[l,i,s],children:t})})),ce=function(e,t,n,a,o){return e&&0!==e.trim().length?new Promise((function(r,i){var s=a,c=new Image;c.onload=function(){var e=n.width,t=n.height;e||t?e?t||(t=e*c.height/c.width):e=t*c.width/c.height:(e=c.width,t=c.height),(o?o(e,t):Promise.resolve()).then((function(){s.drawImage(c,n.x||0,n.y||0,e,t),r(e,t)}))},c.onerror=function(e){console.error("Unable to draw image.",c.src),i("Unable to draw ".concat(t,"Url"))},c.src=e})):(o&&o(),Promise.resolve(n.width,n.height))},ue=n(12),le=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=Object(a.useRef)(null);return Object(a.useEffect)((function(){var t=o.current.getContext(n.context||"2d");e(t)}),[e]),o},de=["id","draw","options"],ge=function(e){var t=e.id,n=e.draw,a=(e.options,Object(ue.a)(e,de)),o=le(n);return Object(oe.jsx)("canvas",Object(u.a)({id:t,ref:o},a))},pe={updateTokens:q},be=Object(c.b)((function(e){return{game:e.game}}),pe)((function(e){var t=e.game,n=(e.updateTokens,t.maps?t.maps[t.mapId]:void 0);return Object(oe.jsx)(ge,{id:"background",onClick:function(e){},width:n?n.width:0,height:n?n.height:0,draw:function(e){n&&ce(n.imageUrl,n.name,n,e,null)}})})),je=Object(c.b)((function(e){return{game:e.game}}),void 0)((function(e){var t=e.game,n=t.width,a=t.height,o=function(){if(0!==t.maps.length){var e=t.maps.filter((function(e){return parseInt(e.$id)===parseInt(t.mapId)}));return e.length>0?e[0]:t.maps[0]}}(),r=function(e,t){e.globalCompositeOperation="source-over",e.beginPath();for(var n=0;n<t.length;n++)e.lineCap="round",e.fillStyle=t[n].drawColor,e.lineWidth=t[n].drawSize,e.strokeStyle=t[n].drawColor,0===n?e.moveTo(t[n].x,t[n].y):e.lineTo(t[n].x,t[n].y)},i=function(e,t){e.globalCompositeOperation="destination-out",e.beginPath();for(var n=0;n<t.length;n++)e.lineCap="round",e.lineWidth=t[n].drawSize,0===n?e.moveTo(t[n].x,t[n].y):e.lineTo(t[n].x,t[n].y)};return Object(oe.jsx)(ge,{id:"drawing",className:"passthrough",width:n,height:a,draw:function(e){if(o&&e){e.beginPath(),e.clearRect(0,0,n,a);for(var t=0;t<o.drawPaths.length;t++){var s=o.drawPaths[t];switch(s.length>0?s[0].tool:""){case"draw":r(e,s);break;case"erease":i(e,s)}e.stroke()}}}})})),fe=Object(c.b)((function(e){return{game:e.game,settings:e.settings,metadata:e.metadata}}),void 0)((function(e){var t=e.game,n=e.metadata,a=e.settings,o=n.isHost?a.fogOpacity:1,r=t.width,i=t.height,s=function(){if(0!==t.maps.length){var e=t.maps.filter((function(e){return parseInt(e.$id)===parseInt(t.mapId)}));return e.length>0?e[0]:t.maps[0]}}(),c=function(e,t){var n;e.beginPath(),e.globalCompositeOperation="destination-out";for(var a=0;a<t.length;a++)(n=e.createRadialGradient(t[a].x,t[a].y,t[a].r2||1,t[a].x,t[a].y,.75*t[a].r)).addColorStop(0,"rgba(0,0,0,255)"),n.addColorStop(1,"rgba(0,0,0,0)"),e.fillStyle=n,e.fillRect(t[a].x-t[a].r,t[a].y-t[a].r,t[a].x+t[a].r,t[a].y+t[a].r)};return t.fogEnabled?Object(oe.jsx)(ge,{id:"fog",className:"passthrough",style:{opacity:o},width:r,height:i,draw:function(e){if(s&&e){e.beginPath(),e.globalCompositeOperation="destination-over",e.fillStyle="black",e.fillRect(0,0,r,i);for(var t=0;t<s.fogPaths.length;t++){var n=s.fogPaths[t];c(e,n),e.stroke()}}}}):null})),me=Object(c.b)((function(e){return{game:e.game}}),void 0)((function(e){var t=e.game,n=e.overlayRef,a=t.maps[t.mapId]||void 0,o=a?a.width:t.width,r=a?a.height:t.height,i=n;return Object(oe.jsx)("canvas",{id:"overlay",ref:i,width:o,height:r})})),he=function(e){var t=e.divStyle,n=e.token,a=e.classes,o=e.imgStyle,r=(e.onMouseUp,e.onMouseDown);return Object(oe.jsx)("div",{style:t,title:n.name,className:a.join(" "),onMouseDown:function(e){return r(e)},children:Object(oe.jsx)("img",{src:n.url,alt:n.name||"",style:o})})},Oe=Object(c.b)((function(e){return{game:e.game,settings:e.settings}}),{})((function(e){var t=e.token,n=e.isHost,a=e.game,o=e.settings;if(!t.url||!t.url.trim())return null;var r=["token",t.ko&&"dead",t.pc?"pc":"npc",t.$selected&&"selected",n&&!t.pc&&"grabbable"],i={left:t.x||0,top:t.y||0},s={width:t.width||void 0,height:t.height||void 0};return void 0===t.mapId||a.mapId===t.mapId?Object(oe.jsx)(he,{divStyle:i,token:t,classes:r,imgStyle:s,onMouseDown:function(e){o.tool}}):null})),ve=function(e){var t=e.cursor,n=e.size,a=e.name,o={top:t.y,left:t.x},r={fontSize:n||void 0};return Object(oe.jsxs)("div",{style:o,className:"cursor",children:[Object(oe.jsx)("span",{role:"img","aria-label":"pointer",style:r,children:"\ud83d\udde1"}),t.u||a]})};var we=function(e){var t=e.title,n=e.value,a=e.onClick,o=e.isSelected,r=e.style,i=e.disabled;return Object(oe.jsx)("button",{title:t,onClick:a,className:o?"selected":null,style:r,disabled:i,children:Object(oe.jsx)("span",{role:"img","aria-label":t,children:n})})};var xe=function(e){var t=e.controlPanelState,n=e.setControlPanelState,a=e.title,o=e.value,r="toggleOn".concat(a),i=t[r];return Object(oe.jsx)(we,{title:a,value:o,onClick:function(){n(Object(u.a)(Object(u.a)({},t),{},Object(W.a)({},r,!t[r])))},isSelected:i})},Se=function(e){var t=e.tool,n=e.subtool,a=e.drawColor,o=e.setDrawColor,r=e.drawSize,i=e.setDrawSize,s=e.fogOpacity,c=e.setFogOpacity,u=e.fogRadius,l=e.setFogRadius,d=e.setSubtool,g=e.resetFog,p=e.resetDrawing;switch(t){case"draw":return Object(oe.jsxs)("span",{children:[Object(oe.jsx)(we,{title:"eraser",value:"\ud83e\uddfd",onClick:function(){return d("eraser")},isSelected:"eraser"===n}),Object(oe.jsx)(we,{title:"pencil",value:"\ud83d\udd8d",onClick:function(){return d("pencil")},isSelected:"pencil"===n}),Object(oe.jsx)("input",{size:"3",title:"draw size",value:r,onChange:function(e){return i(e.target.value)},type:"number",step:"3",min:"1"}),Object(oe.jsx)("input",{size:"3",title:"draw color",value:a,onChange:function(e){return o(e.target.value)}}),Object(oe.jsx)(we,{style:{backgroundColor:a},value:"\ud83d\udd8c",disabled:!0}),Object(oe.jsx)(we,{title:"reset drawing",onClick:p,value:"\ud83c\udf00"})]});case"move":return null;case"fog":return Object(oe.jsxs)("span",{children:[Object(oe.jsx)(we,{title:"reset fog",onClick:g,value:"\ud83c\udf00"}),Object(oe.jsx)("input",{size:"3",title:"fog radius",value:u,onChange:function(e){return l(e.target.value)},type:"number",step:"5",min:"1"}),Object(oe.jsx)("input",{size:"3",title:"fog opacity",step:"0.05",min:"0",max:"1",value:s,onChange:function(e){return c(e.target.value)},type:"number"})]});default:return null}},ke={setToolSettings:L,setDrawToolSettings:function(e,t){return{type:g,drawColor:e,drawSize:parseInt(t)}},setFogToolSettings:function(e,t){return{type:d,fogOpacity:e,fogRadius:parseInt(t)}},resetFog:function(){return{type:M}},resetDraw:function(){return{type:P}}},ye=Object(c.b)((function(e){return{settings:e.settings}}),ke)((function(e){var t=e.settings,n=e.setToolSettings,a=e.setDrawToolSettings,o=e.setFogToolSettings,r=e.resetFog,i=e.resetDraw;return Object(oe.jsx)("span",{children:Object(oe.jsx)(Se,{tool:t.tool,subtool:t.subtool,drawColor:t.drawColor,setDrawColor:function(e){a(e,t.drawSize)},drawSize:t.drawSize,setDrawSize:function(e){var n=e;isNaN(n)||a(t.drawColor,n)},fogOpacity:t.fogOpacity,setFogOpacity:function(e){var n=e;isNaN(n)||o(n,t.fogRadius)},fogRadius:t.fogRadius,setFogRadius:function(e){var n=e;isNaN(n)||o(t.fogOpacity,n)},setSubtool:function(e){n(t.tool,e)},resetFog:function(){r()},resetDrawing:function(){i()}})})})),Ce=function(e){var t=e.isSelected,n=e.mapConfigState,a=e.load,o=e.onTextChange,r=e.onIntegerChange,i=e.deleteMap;return Object(oe.jsxs)("div",{className:t?"selected":null,children:[n.name,Object(oe.jsx)("input",{value:n.imageUrl||"",placeholder:"Map url",size:"8",onChange:function(e){return o("imageUrl",e)}}),"w:",Object(oe.jsx)("input",{value:n.width||0,placeholder:"width",className:"text3",onChange:function(e){return r("width",e)},type:"number",min:"0",step:"10",title:"width"}),"h:",Object(oe.jsx)("input",{value:n.height||0,placeholder:"height",className:"text3",onChange:function(e){return r("height",e)},type:"number",min:"0",step:"10",title:"height"}),Object(oe.jsx)(we,{title:"Save & load map",value:"\ud83d\udcc0",onClick:a}),Object(oe.jsx)(we,{title:"Delete map",value:"\ud83d\uddd1",onClick:i})]})},Ee={loadMap:K,updateMaps:X,deleteMap:function(e){return{type:k,mapId:e}},setIsFogLoaded:function(e){return{type:v,isFogLoaded:e}},setIsFirstLoadDone:function(e){return{type:w,isFirstLoadDone:e}}},Te=Object(c.b)((function(e){return{game:e.game}}),Ee)((function(e){var t=e.map,n=e.game,o=e.loadMap,r=e.updateMaps,i=e.deleteMap,s=e.setIsFogLoaded,c=e.setIsFirstLoadDone,l=Object(a.useState)(function(e,t){var n=t.maps.filter((function(t){return t.$id===e.$id})),a=n.length>0?n[0]:{name:void 0,imageUrl:void 0,w:void 0,h:void 0};return{$id:parseInt(e.$id),name:a.name?a.name:e.name,imageUrl:a.imageUrl?a.imageUrl:"",width:a.width?a.width:window.innerWidth,height:a.height?a.height:window.innerHeight,x:0,y:0}}(t,n)),d=Object(Q.a)(l,2),g=d[0],p=d[1],b=ee(),j=Object(Q.a)(b,2),f=j[0],m=j[1],h=n.mapId===t.$id;return t?Object(oe.jsx)(Ce,{isSelected:h,mapConfigState:g,load:function(){var e=n.maps.map((function(e){return t.$id===e.$id?Object(u.a)(Object(u.a)({},e),{},{imageUrl:g.imageUrl,width:g.width,height:g.height}):e}));r(e),o(t.$id),s(!0),c(!0),function(e,t,n,a){te(e,{type:"pushMapState",from:t.guid,username:t.username,maps:n,mapId:a})}(f,m,e,t.$id)},onTextChange:function(e,t){p(Object(u.a)(Object(u.a)({},g),{},Object(W.a)({},e,t.target.value)))},onIntegerChange:function(e,t){var n=parseInt(t.target.value)||void 0;p(Object(u.a)(Object(u.a)({},g),{},Object(W.a)({},e,n)))},deleteMap:function(){window.confirm("Delete map?")&&i(t.$id)}}):null})),Ne=function(e){var t=e.maps,n=e.newMapName,a=e.setNewMapName,o=e.createMap;return Object(oe.jsxs)("div",{children:[Object(oe.jsx)("hr",{}),Object(oe.jsxs)("div",{children:[Object(oe.jsx)("input",{placeholder:"New map name",onChange:function(e){return a(e.target.value)},value:n}),Object(oe.jsx)(we,{title:"Create new map",value:"\u2795",onClick:o,disabled:""===n}),t.map((function(e){return Object(oe.jsx)(Te,{map:e},"map".concat(e.$id))}))]})]})},Ie={addMap:B},Me=Object(c.b)((function(e){return{game:e.game}}),Ie)((function(e){var t=e.toggleOnMaps,n=e.game,o=e.addMap,r=Object(a.useState)(""),i=Object(Q.a)(r,2),s=i[0],c=i[1],u=ee(),l=Object(Q.a)(u,3),d=l[0],g=l[1],p=(l[2],n.maps);return t?Object(oe.jsx)(Ne,{maps:p,newMapName:s,setNewMapName:c,createMap:function(){o(s,window.innerWidth,window.innerHeight),c(""),function(e,t,n,a,o){te(e,{type:"pushCreateMap",from:t.guid,mapName:n,width:a,height:o})}(d,g,s,window.innerWidth,window.innerHeight)}}):null})),Pe=function(e){var t=e.maps,n=e.token,a=e.copy,o=e.onToggle,r=e.selectToken,i=e.onTextChange,s=e.onIntegerChange,c=e.onMapSelect,u=e.deleteToken;return Object(oe.jsxs)("div",{className:"tokenConfig",children:[Object(oe.jsx)(we,{title:"Duplicate token",value:"\ud83d\udc6f",onClick:a}),Object(oe.jsx)(we,{value:n.pc?"\ud83d\udda5":"\ud83d\udc64",onClick:function(e){return o("pc",e)},title:"pc/npc"}),Object(oe.jsx)(we,{value:n.$selected?"\u2705":"\u274c",onClick:function(e){return r(n,e)},title:"(un)select"}),Object(oe.jsx)(we,{value:n.ko?"\ud83e\udd40":"\ud83c\udf39",onClick:function(e){return o("ko",e)},title:"alive/dead"}),Object(oe.jsx)("input",{value:n.name||"",placeholder:"Name",size:"8",onChange:function(e){return i("name",e)}}),Object(oe.jsx)("input",{value:n.url||"",placeholder:"Url",size:"8",onChange:function(e){return i("url",e)}}),"wh:",Object(oe.jsx)("input",{value:n.width||"",placeholder:"w",className:"text2",onChange:function(e){return s("width",e)},type:"number",step:"5",min:"0",title:"width"}),Object(oe.jsx)("input",{value:n.height||"",placeholder:"h",className:"text2",onChange:function(e){return s("height",e)},type:"number",step:"5",min:"0",title:"height"}),"xy:",Object(oe.jsx)("input",{value:n.x||"",placeholder:"x",className:"text3",onChange:function(e){return s("x",e)},type:"number",step:"5",title:"x coord"}),Object(oe.jsx)("input",{value:n.y||"",placeholder:"y",className:"text3",onChange:function(e){return s("y",e)},type:"number",step:"5",title:"y coord"}),Object(oe.jsxs)("select",{defaultValue:n.mapId,onChange:function(e){return c(e)},title:"which map",children:[Object(oe.jsx)("option",{value:-1,children:"(all)"},-1),t.map((function(e){return Object(oe.jsx)("option",{value:e.name,children:t.name},e.$id)}))]}),Object(oe.jsx)(we,{title:"Delete token",value:"\ud83d\uddd1",onClick:u})]})},Re=function(e){var t=e.token,n=e.onTextChange,a=e.onIntegerChange;return Object(oe.jsxs)("div",{className:"tokenConfig",children:[Object(oe.jsx)("input",{value:t.name||"",placeholder:"Name",size:"8",onChange:function(e){return n("name",e)}}),Object(oe.jsx)("input",{value:t.url||"",placeholder:"Url",size:"8",onChange:function(e){return n("url",e)}}),"wh:",Object(oe.jsx)("input",{value:t.width||"",placeholder:"w",className:"text2",onChange:function(e){return a("width",e)},type:"number",step:"5",min:"0",title:"width"}),Object(oe.jsx)("input",{value:t.height||"",placeholder:"h",className:"text2",onChange:function(e){return a("height",e)},type:"number",step:"5",min:"0",title:"height"}),"xy:",Object(oe.jsx)("input",{value:t.x||"",placeholder:"x",className:"text3",onChange:function(e){return a("x",e)},type:"number",step:"5",title:"x coord"}),Object(oe.jsx)("input",{value:t.y||"",placeholder:"y",className:"text3",onChange:function(e){return a("y",e)},type:"number",step:"5",title:"y coord"})]})},Ae={deleteToken:function(e){return{type:E,tokenGuid:e}},copyToken:function(e){return{type:T,tokenGuid:e}},updateTokenValue:function(e,t,n){return{type:N,tokenGuid:e,key:t,value:n}},toggleTokenValue:function(e,t){return{type:I,tokenGuid:e,key:t}},updateTokens:q},De=Object(c.b)((function(e){return{game:e.game,metadata:e.metadata}}),Ae)((function(e){var t=e.token,n=e.game,a=e.metadata,o=e.deleteToken,r=e.copyToken,i=e.updateTokenValue,s=e.toggleTokenValue,c=function(e,n){i(t.guid,e,parseInt(n.target.value)||void 0)},l=function(e,n){i(t.guid,e,n.target.value)};return Object(oe.jsx)("div",{children:t?a.isHost?Object(oe.jsx)(Pe,{maps:n.maps,token:t,copy:function(){r(t.guid)},onToggle:function(e){s(t.guid,e)},selectToken:function(e,t){if(e.pc||a.isHost){var o=n.tokens.map((function(n){return n.guid===e.guid?Object(u.a)(Object(u.a)({},n),{},{$selected:t||!n.$selected,$x0:n.x,$y0:n.y}):n}));q(o)}},onTextChange:l,onIntegerChange:c,onMapSelect:function(e){var n=parseInt(e.target.value);n<0&&(n=void 0),i(t.guid,"mapId",n)},deleteToken:function(){o(t.guid)}}):Object(oe.jsx)(Re,{token:t,onTextChange:l,onIntegerChange:c}):null})})),Ge=function(e){var t=e.newTokenUrl,n=e.setNewTokenUrl,a=e.createToken,o=e.tokens;return Object(oe.jsxs)("div",{children:[Object(oe.jsx)("hr",{}),Object(oe.jsx)("input",{placeholder:"New token url",onChange:function(e){return n(e.target.value)},value:t}),Object(oe.jsx)(we,{title:"Create new token",value:"\u2795",onClick:a}),o.map((function(e,t){return Object(oe.jsx)(De,{token:e},"token".concat(t))}))]})},ze=function(e){var t=e.tokens.filter((function(e){return e.$selected}));return Object(oe.jsx)("div",{children:t.map((function(e,t){return Object(oe.jsx)(De,{token:e},"token".concat(t))}))})},Ue=Object(c.b)((function(e){return{game:e.game}}),void 0)((function(e){var t=e.game.tokens.filter((function(e){return e.$selected}));return Object(oe.jsx)(ze,{tokens:t})})),Le={addToken:function(e,t,n){var a={guid:J(),name:e,url:t,mapId:n,$selected:void 0,$x0:0,$y0:0,x:0,y:0,ko:void 0,pc:void 0,w:0,h:0};return{type:C,token:a}}},Fe=Object(c.b)((function(e){return{game:e.game,metadata:e.metadata}}),Le)((function(e){var t=e.toggleOnTokens,n=e.game,o=e.addToken,r=e.metadata,i=Object(a.useState)(""),s=Object(Q.a)(i,2),c=s[0],u=s[1];if(!r.isHost)return null;return t?Object(oe.jsx)(Ge,{newTokenUrl:c,setNewTokenUrl:u,createToken:function(){c&&(o(void 0,c,n.mapId),u(""))},tokens:n.tokens}):Object(oe.jsx)(Ue,{tokens:n.tokens})})),$e=function(e){var t=e.initAsDev,n=e.toggleFog,a=e.copyJson,o=e.pasteJson,r=e.username,i=e.updateUsername,s=e.cursorSize,c=e.updateCursorSize;return Object(oe.jsxs)("div",{children:[Object(oe.jsx)("hr",{}),Object(oe.jsx)("input",{title:"User name",placeholder:"User name",value:r,onChange:function(e){return i(e.target.value)}}),Object(oe.jsx)("input",{title:"Cursor size",value:s,onChange:function(e){return c(e.target.value)},type:"number",min:"0"}),Object(oe.jsx)("hr",{}),Object(oe.jsx)(we,{title:"Redo as dev",value:"\ud83d\udd30",onClick:t}),Object(oe.jsx)(we,{title:"Toggle fog",value:"\ud83c\udf2b",onClick:n}),Object(oe.jsx)(we,{title:"Copy JSON to clipboard",value:"\ud83d\udc6f",onClick:a}),Object(oe.jsx)(we,{title:"Paste JSON from clipboard",value:"\ud83d\udccb",onClick:o})]})},_e={setUsername:F,setCursorSize:U,setFogEnabled:Y,setToolSettings:L},He=Object(c.b)((function(e){return{game:e.game,settings:e.settings}}),_e)((function(e){var t=e.toggleOnUser,n=e.game,a=e.settings,o=e.setFogEnabled,r=e.setUsername,i=e.setCursorSize,s=e.setToolSettings,c=ee(),l=Object(Q.a)(c,3),d=l[0],g=l[1],p=l[2];if(!t)return null;return t?Object(oe.jsx)($e,{initAsDev:function(){},toggleFog:function(){o(!n.fogEnabled),function(e,t,n){te(e,{type:"pushFogEnabled",from:t.guid,fogEnabled:n})}(d,g,!n.fogEnabled),"fog"===a.tool&&s("move","")},copyJson:function(){},pasteJson:function(){},username:a.username,updateUsername:function(e){r(e),p(Object(u.a)(Object(u.a)({},g),{},{username:e}))},cursorSize:a.cursorSize,updateCursorSize:function(e){var t=e;isNaN(t)||i(t)}}):null}));var We={setToolSettings:L},Je=Object(c.b)((function(e){return{settings:e.settings}}),We)((function(e){var t=e.title,n=e.value,a=e.settings,o=e.setToolSettings,r=t===a.tool;return Object(oe.jsx)(we,{title:t,value:n.toString(),onClick:function(){o(t,void 0)},isSelected:r})})),Ve=function(e){var t=e.fogEnabled;return Object(oe.jsxs)("span",{id:"tools",children:[Object(oe.jsx)(Je,{title:"move",value:"\ud83e\uddf3"}),Object(oe.jsx)(Je,{title:"draw",value:"\ud83d\udd8d"}),t?Object(oe.jsx)(Je,{title:"fog",value:"\ud83c\udf2c"}):null]})},Ke=function(e){var t=e.controlPanelState,n=e.setControlPanelState,a=e.hidden,o=e.toggleHidden,r=e.fogEnabled,i=e.isHost,s=e.username,c=e.setUsername,u=e.cursorSize,l=e.setCursorSize,d=e.socketRequestRefresh,g=e.pushRefreshToPlayers;return a?Object(oe.jsxs)("div",{id:"control-panel",children:["\xa0\xa0\xa0\xa0",Object(oe.jsx)(we,{value:"\ud83d\udc41",onClick:o,title:"show/hide control panel"}),"\xa0\xa0\xa0\xa0"]}):i?Object(oe.jsxs)("div",{id:"control-panel",children:["\xa0\xa0\xa0\xa0",Object(oe.jsx)(we,{value:"\ud83d\udc41",onClick:o,title:"show/hide control panel"}),"\xa0\xa0\xa0\xa0",Object(oe.jsx)(xe,{title:"User",value:"\ud83e\uddd9\u200d\u2642\ufe0f",controlPanelState:t,setControlPanelState:n}),Object(oe.jsx)(xe,{title:"Maps",value:"\ud83d\uddfa",controlPanelState:t,setControlPanelState:n}),Object(oe.jsx)(xe,{title:"Tokens",value:"\u265f",controlPanelState:t,setControlPanelState:n}),Object(oe.jsx)(we,{title:"Push refresh to players",value:"\ud83d\udcab",onClick:g}),"\xa0\xa0\xa0\xa0",Object(oe.jsx)(Ve,{fogEnabled:r}),"\xa0\xa0\xa0\xa0",Object(oe.jsx)(ye,{}),Object(oe.jsx)(Me,{toggleOnMaps:t.toggleOnMaps}),Object(oe.jsx)(Fe,{toggleOnTokens:t.toggleOnTokens}),Object(oe.jsx)(He,{toggleOnUser:t.toggleOnUser})]}):Object(oe.jsxs)("div",{id:"control-panel",children:[Object(oe.jsx)(we,{value:"\ud83d\udc41",onClick:o,title:"show/hide control panel"}),Object(oe.jsx)("input",{title:"User name",placeholder:"User name",value:s,onChange:function(e){return c(e.target.value)}}),Object(oe.jsx)(xe,{title:"Share mouse (cursor)",value:"\ud83d\udc01",controlPanelState:t,setControlPanelState:n}),Object(oe.jsx)("input",{title:"Cursor size",value:u,onChange:function(e){return l(parseInt(e.target.value))},type:"number",min:"0"}),Object(oe.jsx)(we,{title:"Request gameboard refresh from host",onClick:d,value:"\ud83d\udcab"}),Object(oe.jsx)(Ue,{})]})},Ye=function(){return{hidden:!1,toggleOnMaps:!1,toggleOnUser:!1,toggleOnTokens:!1}},Xe={setUsername:F,setCursorSize:U},Be=Object(c.b)((function(e){return{game:e.game,settings:e.settings,metadata:e.metadata}}),Xe)((function(e){var t=e.game,n=e.settings,o=e.metadata,r=e.setUsername,i=e.setCursorSize,s=Object(a.useState)(Ye),c=Object(Q.a)(s,2),l=c[0],d=c[1],g=ee(),p=Object(Q.a)(g,3),b=p[0],j=p[1],f=p[2];return Object(oe.jsx)(Ke,{controlPanelState:l,setControlPanelState:d,hidden:l.hidden,toggleHidden:function(){d(Object(u.a)(Object(u.a)({},l),{},{hidden:!l.hidden}))},fogEnabled:t.fogEnabled,isHost:o.isHost,username:n.username,setUsername:function(e){r(e),f(Object(u.a)(Object(u.a)({},j),{},{username:e}))},cursorSize:n.cursorSize,setCursorSize:function(e){var t=e;isNaN(t)||i(t)},socketRequestRefresh:function(){ae(b,j)},pushRefreshToPlayers:function(){ne(b,j,t)}})})),qe=function(e){var t=e.isHost,n=e.overlayRef,a=e.isFogLoaded,o=e.cursors,r=e.cursorSize,i=e.tokens,s=e.onMouseMove,c=e.onMouseUp,u=e.onMouseDown,l=a?null:"gone";return Object(oe.jsxs)("div",{id:"game",onMouseMove:function(e){return s(e)},onMouseDown:function(e){return u(e)},onMouseUp:function(e){return c(e)},children:[Object(oe.jsxs)("div",{className:l,children:[Object(oe.jsx)(be,{}),Object(oe.jsx)(je,{}),i?Object(oe.jsx)("div",{id:"tokens",children:i.map((function(e,n){return Object(oe.jsx)(Oe,{token:e,isHost:t},"Token".concat(n))}))}):null,Object(oe.jsx)(fe,{}),o?Object(oe.jsx)("div",{id:"cursors",children:o.map((function(e){return Object(oe.jsx)(ve,{name:e.username,cursor:e,size:r},"cursor".concat(e.$id))}))}):null,Object(oe.jsx)(me,{overlayRef:n})]}),Object(oe.jsx)(Be,{})]})},Ze={setGameSettings:function(e,t){return{type:R,isHost:e,room:t}},overwriteGame:function(e){return{type:f,game:e}},loadMap:K,updateMaps:X,addMap:B,incrementGen:function(){return{type:h}},setFogEnabled:Y},Qe=Object(c.b)((function(e){return{metadata:e.metadata,game:e.game,settings:e.settings}}),Ze)((function(e){var t=e.metadata,n=e.game,r=e.settings,i=e.setGameSettings,s=e.overwriteGame,c=e.loadMap,l=e.updateMaps,d=e.addMap,g=(e.incrementGen,e.setFogEnabled),p=o.a.useRef(),b=ee(),j=Object(Q.a)(b,3),f=j[0],m=j[1],h=j[2],O=[],v=function(e,t,n,a){if(null!=n){var o=p.current.getContext("2d");o.strokeStyle=n,o.lineWidth="3",o.beginPath(),o.arc(e,t,a,0,2*Math.PI),o.stroke(),o.closePath()}},w=function(){},x=function(e){},S=function(){var e="eraser"===r.subtool;switch(r.tool){case"draw":return e?"erease":"draw";default:return r.tool}},k=function(){};var y=Object(a.useCallback)((function(e){var a=JSON.parse(e.data);if(a.from!==m.guid&&(!a.to||a.to===m.guid)){var o=function(){if(0!==n.maps.length){var e=n.maps.filter((function(e){return e.$id===n.mapId}));return e.length>0?e[0]:n.maps[0]}}();switch(a.type){case"pushCursor":break;case"pushDrawPath":var r=o.drawPaths?o.drawPaths:[];r.push(a.drawPath);var i=n.maps.map((function(e){return e.$id===o.$id?Object(u.a)(Object(u.a)({},o),{},{drawPaths:r}):e}));l(i);break;case"pushDrawReset":var p=n.maps.map((function(e){return e.$id===o.$id?Object(u.a)(Object(u.a)({},o),{},{drawPaths:[]}):e}));l(p);break;case"pushFogPath":var b=o.fogPaths?o.fogPaths:[];b.push(a.fogPath);var j=n.maps.map((function(e){return e.$id===o.$id?Object(u.a)(Object(u.a)({},o),{},{fogPaths:b}):e}));l(j);break;case"pushFogReset":var h=n.maps.map((function(e){return e.$id===o.$id?Object(u.a)(Object(u.a)({},o),{},{fogPaths:[]}):e}));l(h);break;case"pushSingleToken":case"pushTokens":break;case"pushMapId":c(a.mapId);break;case"pushMapState":l(a.maps),c(a.mapId);break;case"pushCreateMap":d(a.mapName,a.width,a.height);break;case"pushFogEnabled":console.log("receiving fog enabled",a),g(a.fogEnabled);break;case"pushGameRefresh":s(a.game);break;case"requestRefresh":t.isHost&&ne(f,m,n,{to:a.from});break;default:console.error("Unrecognized websocket message type: ".concat(a.type))}}}),[n,t.isHost,c,s,l,d,f,m]);Object(a.useEffect)((function(){window.addEventListener("beforeunload",k),window.addEventListener("resize",w),window.addEventListener("keydown",x);var e=new URLSearchParams(window.location.href.replace(/.*\?/,""));return i(e.get("host"),e.get("room")),function(){window.removeEventListener("beforeunload",k),window.removeEventListener("resize",w),window.removeEventListener("keydown",x)}}),[]),Object(a.useEffect)((function(){document.title="Borealis D&D, Room: ".concat(t.room)}),[t.room]),Object(a.useEffect)((function(){return f&&(f.addEventListener("message",y),""===m.username&&h(Object(u.a)(Object(u.a)({},m),{},{username:r.username}))),function(){f&&f.removeEventListener("message",y)}}),[f,m,h,y,r.username]);var C=new Date-3e4,E=t.cursors;for(var T in E){var N=E[T].time;(!N||N<C)&&delete E[T]}try{return Object(oe.jsx)(qe,{isHost:t.isHost,overlayRef:p,isFogLoaded:n.isFogLoaded,cursors:E,cursorSize:r.cursorSize,tokens:n.tokens,onMouseMove:function(e){if(p){!function(){var e=p.current.getContext("2d");e&&e.clearRect(0,0,n.width,n.height)}();var a=e.pageX,o=e.pageY;switch(t.isHost?r.tool:"move"){case"fog":!function(){var e,t=p.current.getContext("2d");t.beginPath();for(var n=0;n<O.length;n++)e=t.createRadialGradient(O[n].x,O[n].y,O[n].r2||1,O[n].x,O[n].y,.75*O[n].r),t.lineCap="round",e.addColorStop(0,"rgba(255,255,255,255)"),e.addColorStop(1,"rgba(255,255,255,0)"),t.fillStyle=e,t.fillRect(O[n].x-O[n].r,O[n].y-O[n].r,O[n].x+O[n].r,O[n].y+O[n].r);t.stroke()}(),v(a,o,"yellow",r.fogRadius);break;case"draw":!function(){var e=p.current.getContext("2d");e.beginPath();for(var t=0;t<O.length;t++)e.lineCap="round",e.fillStyle=O[t].drawColor,e.lineWidth=O[t].drawSize,e.strokeStyle=O[t].drawColor,0===t?e.moveTo(O[t].x,O[t].y):e.lineTo(O[t].x,O[t].y);e.stroke()}(),v(a,o,r.drawColor,r.drawSize);break;case"move":e.buttons}("fog"===r.tool||"draw"===r.tool)&&1&e.buttons&&O.push({x:a,y:o,r:r.fogRadius,r2:void 0,tool:S(),drawColor:r.drawColor,drawSize:r.drawSize})}},onMouseUp:function(e){var a=function(){if(0!==n.maps.length){var e=n.maps.filter((function(e){return e.$id===n.mapId}));return e.length>0?e[0]:n.maps[0]}}();if(a&&t.isHost){var o=a.fogPaths,i=a.drawPaths;switch(r.tool){case"fog":o.push(O),function(e,t,n){te(e,{type:"pushFogPath",from:t.guid,username:t.username,fogPath:n})}(f,m,O);break;case"draw":i.push(O),function(e,t,n){te(e,{type:"pushDrawPath",from:t.guid,username:t.username,drawPath:n})}(f,m,O)}O=[];var s=n.maps.map((function(e){return e.$id===a.$id?Object(u.a)(Object(u.a)({},a),{},{fogPaths:o,drawPaths:i}):e}));l(s)}},onMouseDown:function(e){for(var n=0,a=[document.activeElement,e.target];n<a.length;n++){var o=a[n];if("INPUT"==o.tagName&&("text"===o.type||"number"===o.type)||"BUTTON"==o.tagName)return e}t.isHost&&1&e.buttons&&(O=[]).push({x:e.pageX,y:e.pageY,r:r.fogRadius,r2:void 0,tool:S(),drawColor:r.drawColor,drawSize:r.drawSize})}})}catch(I){!function(e){console.error(e),console.error("Exception in `render`. Clearing localStorage..."),localStorage.removeItem(t.room),window.alert("Fatal error. Local storage cleared.")}(I)}})),et=function(){var e=Object(s.a)({settings:$,metadata:H,game:Z}),t=Object(s.b)(e);return Object(oe.jsx)(c.a,{store:t,children:Object(oe.jsx)(se,{children:Object(oe.jsx)(Qe,{})})})};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(Object(oe.jsx)(o.a.StrictMode,{children:Object(oe.jsx)(et,{})}),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[30,1,2]]]);
//# sourceMappingURL=main.9ead184d.chunk.js.map